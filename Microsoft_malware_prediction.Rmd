---
title: "Microsoft Malware Prediction"
author: "Vadiwoo Karuppiah"
date: "11/12/2019"
output: html_document
---


### Install Required packages
```{r install_packages}
#install.packages("naivebayes")
#install.packages("rpart")
#install.packages("rpart.plot")
#install.packages("readr")

```

### **Load required Libraries**
```{r Load_Libraries, results='hide',warning=FALSE}

library(rpart)
library(rpart.plot)
library(readr)
library(rpart)
library(rpart.plot)
library(readr)
library(ggplot2)
library(lattice)
library(caret)
library(C50)
library(randomForest)
library(nnet)
library(rattle)
library(RRF)
library(dplyr)
library(magrittr)
library(tidyverse)
library(rsample)
library(recipes)
library(keras)
library(corrplot)
library(RColorBrewer)
library(data.table)
library(GGally)
```

### **Loading the train and dataset**
```{r load_data, warning=FALSE}
#malware_data <- read.csv("train.csv")
malware_train_data <- fread("trainSample1.csv", header= T, sep=",")
```
```{r view of train_data structure}
str(malware_train_data)
colnames(malware_train_data)
malware_train_data$HasDetectionsF <- factor(malware_train_data$HasDetection)
str(malware_train_data)
```

```{r}
# Check if there are any na values in the dataset.
sum(is.na(malware_train_data))

### Identifying Missing Values
sum(complete.cases(malware_train_data))

```
#drop NA
```{r drop na }
malware_train_data <- malware_train_data %>% drop_na()
dim(malware_train_data)
```
#or Fix NA
```{ drop na }
malware_train_data_fix_na=malware_train_data
malware_train_data_fix_na[is.na(malware_train_data_fix_na)]<-0
dim(malware_train_data)
```

### Data Transformation

```{r}
#Convert all data frame characters columns to factors
malware_train_data <- as.data.frame(unclass(malware_train_data))
str(malware_train_data)

#view of numeric columns
malware_numeric <- select_if(malware_train_data, is.numeric)
str(malware_numeric)

#view of factor columns
malware_factor <- malware_train_data %>% select_if(is.factor)
str(malware_factor)
#malware_numeric <- malware_numeric %>%  select(-MachineIdentifier)%>%  select(-AvSigVersion)%>%  select(-AvSigVersion)



```
### **Loading the test dataset**
```{ test_dataset}
#malware_data <- read.csv("train.csv")
malware_test_data <- fread("testSample1.csv", header= T, sep=",")
```
```{ view of test_data structure}
str(malware_test_data)

```

```{ test_data_view}
# Check if there are any na values in the dataset.
sum(is.na(malware_test_data))

### Identifying Missing Values
sum(complete.cases(malware_test_data))

malware_test_data <- malware_test_data %>% drop_na()
dim(malware_test_data)

```


#Convert all data frame characters columns to factors in testdata
```{}
malware_test_data <- as.data.frame(unclass(malware_test_data))
str(malware_test_data)
#head(malware_no_NA)
#view of numeric columns
malware_test_numeric <- select_if(malware_test_data, is.numeric)
str(malware_test_numeric)

#view of factor columns
malware_test_factor <- malware_test_data %>% select_if(is.factor)
str(malware_test_factor)
#malware_numeric <- malware_numeric %>%  select(-MachineIdentifier)%>%  select(-AvSigVersion)%>%  select(-AvSigVersion)




```"
#RtpStateBitfield", "DefaultBrowsersIdentifier AVProductStatesIdentifier AVProductsInstalled AVProductsEnabled IeVerIdentifier, Census_OSBuildNumber Census_OSBuildRevision

```{r feature selection }
selection_1 = names(malware_train_data) %in% c("EngineVersion", "AppVersion", "AvSigVersion", "RtpStateBitfield", "DefaultBrowsersIdentifier", "AVProductStatesIdentifier", "AVProductsInstalled","AVProductsEnabled", "OsBuild",  "OsPlatformSubRelease", "OsBuildLab", "IeVerIdentifier" , "SmartScreen", "Census_OSVersion","Census_OSBranch", "Census_OSBuildNumber" , "Census_OSBuildRevision", "Census_OSInstallTypeName", "HasDetectionsF")

selection_2 = names(malware_train_data) %in% c("EngineVersion","AvSigVersion", "AVProductsInstalled", "IeVerIdentifier","SmartScreen","HasDetectionsF")

newdata = malware_train_data[selection_1]
newdata = na.omit(newdata)
str(newdata)

```
```{r data partition}
clean_data <- newdata 
datasample <- sample(2, nrow(clean_data), replace=TRUE,prob = c(0.8,0.2))

traindata <- clean_data[datasample==1,]
testdata <- clean_data[datasample==2,]

```
### Bulding Decision Tree
```{r building the model}
dt_model <-rpart(formula = HasDetectionsF~ ., data = traindata, method = "class")

typeof(dt_model)
print(dt_model)


fit <- rpart(HasDetectionsF~., data = traindata, method = 'class')
rpart.plot(fit, extra = 106)

#Predicting "HasDetections" on Test Data
predict_att <-predict(fit, testdata, type = 'class')
table_mat <- table(testdata$HasDetectionsF, predict_att)
table_mat

#Predicting "HasDetections" on Train Data
predict_att_train <-predict(fit, traindata, type = 'class')
table_mat_train <- table(traindata$HasDetectionsF, predict_att_train)
table_mat_train
```
#Performance Measurement
```{r}
accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
print(paste('Accuracy for test', accuracy_Test))
```
```{r}
#Performance Measurement on Train Data
accuracy_Train <- sum(diag(table_mat_train)) / sum(table_mat_train)
print(paste('Accuracy for train', accuracy_Train))

```


















