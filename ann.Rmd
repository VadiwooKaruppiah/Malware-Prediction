---
title: "Microsoft Malware Prediction-neural-network"
author: "Vadiwoo Karuppiah"
date: "11/12/2019"
output: html_document
---
```{r, loading data}
library(data.table)
malware_train_data <- fread("trainSample1.csv", header= T, sep=",")
dim(malware_train_data)
```
```{r , data transformation}
library(dplyr)
library(tidyverse)
library(magrittr)
#drop NA's
malware_train_data <- malware_train_data %>% drop_na()
dim(malware_train_data)
#charcter to factor
malware_train_data <- as.data.frame(unclass(malware_train_data))
str(malware_train_data)
#factor to numeric
malware_train_data %<>% mutate_if(is.factor, as.numeric)
str(malware_train_data)
#malware_numeric <- select_if(malware_train_data, is.numeric)

#normalize
normalize <- function(x) {
  return ((x-min(x))/ (max(x) - min(x)))
} 
maxmindf <- as.data.frame(lapply(malware_train_data, normalize))
```
```{r, data partition}
set.seed(1234)
library(caret)
TrainingDataIndex <- createDataPartition(maxmindf$HasDetections, p=0.70, list = FALSE)
#Training Data
trainset <- maxmindf[TrainingDataIndex,]
#Test Data
testset <- maxmindf[-TrainingDataIndex,]
```
```{r, building model}

sigmoid = function(x) {
  1 / (1 + exp(-x))
}

TanH = function(x) {
  (2 / (1 + exp(-x*2))) -1
}

#ReLu = function(x) {
  #max(0,x)
#}

ReLu<-function(x){ifelse(x>=0,x,0)}
x <- seq(-5, 5, 0.01)
plot(x, sigmoid(x), col='blue')
plot(x, TanH(x), col='blue')
plot(x, ReLu(x), col='blue')
library(sigmoid)
library(neuralnet)
#nn <- neuralnet(HasDetections~ AVProductsInstalled + AVProductStatesIdentifier +DefaultBrowsersIdentifier +AVProductsEnabled + CountryIdentifier + IeVerIdentifier +IsProtected + Census_TotalPhysicalRAM + Wdft_IsGamer + Census_OSBuildNumber + Census_OSBuildRevision +RtpStateBitfield, data=trainset, hidden=c(2,1), linear.output=FALSE, threshold=0.01 )
nn <- neuralnet(HasDetections~ EngineVersion+ AVProductsInstalled+ AvSigVersion +IeVerIdentifier + Census_OSInstallTypeName + SmartScreen + OsBuild, data=trainset, hidden=c(2), linear.output=TRUE, threshold=0.01)
nn$result.matrix
plot(nn, rep = "best")
```
```{r, validating model }
tmp_test <-subset(testset, select = c("EngineVersion","AVProductsInstalled","AvSigVersion" ,"IeVerIdentifier","Census_OSInstallTypeName", "SmartScreen", "OsBuild"))
head(tmp_test)
nn.results <- compute(nn, tmp_test)

#Accuracy
results <- data.frame(actual = testset$HasDetections, prediction = nn.results$net.result)
#results
roundedresults<-sapply(results,round,digits=0)
roundedresultsdf=data.frame(roundedresults)
attach(roundedresultsdf)
table(actual,prediction)
accuracy <- sum(diag(table(actual,prediction))) / sum(table(actual,prediction))
print(paste('Accuracy for train', accuracy))

 par(mfrow=c(2,2))
 gwplot(nn,selected.covariate="EngineVersion", min=-2.5, max=5)
gwplot(nn,selected.covariate="AvSigVersion",min=-2.5, max=5)
gwplot(nn,selected.covariate="AVProductsInstalled", min=-2.5, max=5)
gwplot(nn,selected.covariate="IeVerIdentifier",min=-2.5, max=5)
gwplot(nn,selected.covariate="SmartScreen",min=-2.5, max=5)
gwplot(nn,selected.covariate="Census_OSInstallTypeName",min=-2.5, max=5)
gwplot(nn,selected.covariate="OsBuild", min=-2.5, max=5)


```
