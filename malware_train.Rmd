---
title: "Microsoft Malware Prediction"
author: "Vadiwoo Karuppiah"
date: "11/12/2019"
output: html_document
---


### Install Required packages
```{r install_packages}
#install.packages("naivebayes")
#install.packages("rpart")
#install.packages("rpart.plot")
#install.packages("readr")

```

### **Load required Libraries**
```{r Load_Libraries, results='hide',warning=FALSE}

library(rpart)
library(rpart.plot)
library(readr)
library(rpart)
library(rpart.plot)
library(readr)
library(ggplot2)
library(lattice)
library(caret)
library(C50)
library(randomForest)
library(nnet)
library(rattle)
library(RRF)
library(dplyr)
library(magrittr)
library(tidyverse)
library(rsample)
library(recipes)
library(keras)
library(corrplot)
library(RColorBrewer)
library(data.table)
library(GGally)
```

### **Loading the train dataset**
```{r load_data, warning=FALSE}
#malware_data <- read.csv("train.csv")
malware_train_data <- fread("trainSample1.csv", header= T, sep=",")
```
```{r, time}
system.time(DF1 <- read.csv("trainSample1.csv"))
system.time(DF2 <- fread("train.csv", header= T, sep=","))
dim(DF1)
```
```{r view of train_data structure}
str(malware_train_data)
colnames(malware_train_data)
```

```{r}
# Check if there are any na values in the dataset.
sum(is.na(malware_train_data))

### Identifying Missing Values
sum(complete.cases(malware_train_data))

```

```{r}
malware_train_data <- malware_train_data %>% drop_na()
dim(malware_train_data)
sum(is.na(malware_train_data))
head(malware_train_data)
tail(malware_train_data)

```
### Convert all data frame characters columns to factors
```{r}
malware_train_data <- as.data.frame(unclass(malware_train_data))
str(malware_train_data)
#head(malware_no_NA)
#view of numeric columns
malware_numeric <- select_if(malware_train_data, is.numeric)
str(malware_numeric)
#correlation of data
#cor_matrix <- cor(malware_numeric, method= "pearson")
#corrplot(cor_matrix, type = "upper")
#view of factor columns
malware_factor <- malware_train_data %>% select_if(is.factor)
str(malware_factor)
#malware_numeric <- malware_numeric %>%  select(-MachineIdentifier)%>%  select(-AvSigVersion)%>%  select(-AvSigVersion)

#malware_numeric[,"HasDetections"]


```
### Data Visualization
```{r visualization}

#pearson correlation
cor_matrix <- cor(malware_train_data[ sapply(malware_train_data, is.numeric)], method= "pearson")
corrplot(cor_matrix, type = "full")
dim(cor_matrix)


correlationMatrix <- cor(malware_numeric[,2:18])
corrplot(correlationMatrix, type = "low")

correlationMatrix <- cor(malware_numeric[,11:21])
corrplot(correlationMatrix, type = "low")

correlationMatrix <- cor(malware_numeric[,21:40])
corrplot(correlationMatrix, type = "low")

correlationMatrix <- cor(malware_numeric[,41:51])
corrplot(correlationMatrix, type = "low")

#correlationMatrix
#findCorrelation(correlationMatrix, cutoff=0.75, )

#ggcor
ggcor_matrix <- cor(malware_train_data[ sapply(malware_train_data, is.numeric)])
ggcorr(ggcor_matrix, label = TRUE, 
       label_alpha = TRUE)

malware_train_data <- malware_train_data %>%select(c(-1))

#IsBeta
ggplot(malware_train_data, aes(x=factor(IsBeta), y=HasDetections, fill=factor(IsBeta,), horizonatal=TRUE)) + geom_boxplot()

#RtpStateBitfield
ggplot(malware_train_data, aes(x=factor(RtpStateBitfield), y=HasDetections, fill=factor(RtpStateBitfield))) + geom_boxplot()

#IsSxsPassiveMode
ggplot(malware_train_data, aes(x=factor(IsSxsPassiveMode), y=HasDetections, fill=factor(IsSxsPassiveMode))) + geom_boxplot()

#DefaultBrowsersIdentifier
ggplot(malware_train_data, aes(x=factor(DefaultBrowsersIdentifier), y=HasDetections, fill=factor(DefaultBrowsersIdentifier))) + geom_boxplot()

#AVProductsInstalled
ggplot(malware_train_data, aes(x=factor(IsSxsPassiveMode), y=HasDetections, fill=factor(IsSxsPassiveMode))) + geom_boxplot()

#Census_PrimaryDiskTotalCapacity 
ggplot(malware_train_data, aes(x=factor(Census_PrimaryDiskTotalCapacity ), y=HasDetections, fill=factor(Census_PrimaryDiskTotalCapacity ))) + geom_boxplot()

#OsBuild
ggplot(malware_train_data, aes(x=factor(OsBuild), y=HasDetections, fill=factor(OsBuild))) + geom_boxplot()

#Processor
ggplot(malware_train_data, aes(x=factor(Processor), y=HasDetections, fill=factor(Processor))) + geom_boxplot()
#Platform
ggplot(malware_train_data, aes(x=factor(Platform), y=HasDetections, fill=factor(Platform))) + 
  geom_boxplot()

#SmartScreen
ggplot(malware_train_data, aes(x=factor(SmartScreen), y=HasDetections, fill=factor(SmartScreen))) + geom_boxplot()
#country Identifier
ggplot(malware_train_data, aes(x=factor(CountryIdentifier), y=HasDetections, fill=factor(CountryIdentifier))) + geom_boxplot()

#AVProductStatesIdentifier
ggplot(malware_train_data, aes(x=factor(AVProductStatesIdentifier), y=HasDetections, fill=factor(AVProductStatesIdentifier))) + geom_boxplot()

#Census_TotalPhysicalRAM
ggplot(malware_train_data, aes(x=factor(Census_TotalPhysicalRAM), y=HasDetections, fill=factor(Census_TotalPhysicalRAM))) + geom_boxplot()

#Census_ProcessorCoreCount
ggplot(malware_train_data, aes(x=factor(Census_ProcessorCoreCount), y=HasDetections, fill=factor(Census_ProcessorCoreCount))) + geom_boxplot()

#IsProtected
ggplot(malware_train_data, aes(x=factor(IsProtected), y=HasDetections, fill=factor(IsProtected))) + 
  geom_boxplot()

# FACtor
#
#Census_ActivationChannel
ggplot(malware_train_data, aes(x=(Census_ActivationChannel), y=HasDetections, fill=(Census_ActivationChannel))) + 
  geom_boxplot()

#Census_OSInstallTypeName
ggplot(malware_train_data, aes(x=(Census_OSInstallTypeName), y=HasDetections, fill=(Census_OSInstallTypeName))) + 
  geom_boxplot()




```

# Train an rpart model and compute variable importance.
```{r}
set.seed(100)
malware_rfe <- malware_train_data %>%  select(-ProductName)%>%  select(-Census_DeviceFamily) %>%  select(-PuaMode)
rPartMod <- train(HasDetections~ ., data=malware_rfe, method="rpart")
rpartImp <- varImp(rPartMod)
print(rpartImp)
```
```{r, boruta}
library(ranger)
library(Boruta)

# Perform Boruta search
boruta_output <- Boruta(HasDetections ~ ., data=na.omit(malware_train_data), doTrace=2) 
names(boruta_output)


# Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif) 

# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 = imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
head(imps2[order(-imps2$meanImp), ])  # descending sort

# Plot variable importance
plot(boruta_output, cex.axis=.7, las=2, xlab="", main="Variable Importance")  

```




